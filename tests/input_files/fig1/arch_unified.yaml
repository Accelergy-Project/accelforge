{%- set format_type = format_type | default('none') -%}
# Unified arch for fig1: ERT values + bandwidth-based latency + memory sizes.
# Combines arch_energy.yaml + arch_latency.yaml into one file.
# ERT values from ARTIFACT_EVALUATION.md section 2.10.
# Memory sizes: BackingStorage=131072, Buffer=512, Reg=1 (in elements).
# Sparse format: {{ format_type }} (none/bitmask/coord_list)

arch:
  nodes:
  - !Memory
    name: BackingStorage
    size: 131072
    leak_power: 0
    area: 0
    total_latency: "ceil(read_actions + metadata_read_actions)"
    tensors: {keep: ~Intermediates, may_keep: All}
    actions:
    - {name: read, energy: 32.2859, bits_per_action: 64, latency: 0}
    - {name: write, energy: 26.065, bits_per_action: 64, latency: 0}
    - {name: metadata_read, energy: 14.0361, bits_per_action: 64, latency: 0}
{%- if format_type == 'bitmask' %}
    representation_format:
    - name: A
      format: bitmask
      metadata_word_bits: 1
      metadata_storage_width: 28
      uop_payload_word_bits: 0
    - name: B
      format: bitmask
      metadata_word_bits: 1
      metadata_storage_width: 28
      uop_payload_word_bits: 0
{%- elif format_type == 'coord_list' %}
    representation_format:
    - name: A
      format: csr
      metadata_word_bits: 14
      metadata_storage_width: 28
      uop_payload_word_bits: 0
    - name: B
      format: csr
      metadata_word_bits: 14
      metadata_storage_width: 28
      uop_payload_word_bits: 0
{%- endif %}

  - !Memory
    name: Buffer
    size: 512
    leak_power: 0
    area: 0
    total_latency: "ceil(max((read_actions + metadata_read_actions) / 2, (write_actions + metadata_write_actions) / 2))"
    tensors: {keep: ~BackingStorage, may_keep: All}
    actions:
    - {name: read, energy: 0.42568, bits_per_action: 8, latency: 0}
    - {name: write, energy: 0.58331, bits_per_action: 8, latency: 0}
    - {name: gated_read, energy: 0.00001, bits_per_action: 8, latency: 0}
    - {name: metadata_read, energy: 0.7383, bits_per_action: 8, latency: 0}
    - {name: metadata_write, energy: 1.42366, bits_per_action: 8, latency: 0}
    - {name: gated_metadata_read, energy: 0.00002, bits_per_action: 8, latency: 0}
{%- if format_type == 'bitmask' %}
    representation_format:
    - name: A
      format: bitmask
      metadata_word_bits: 1
      metadata_storage_width: 28
      uop_payload_word_bits: 0
    - name: B
      format: bitmask
      metadata_word_bits: 1
      metadata_storage_width: 28
      uop_payload_word_bits: 0
    action_optimization:
    - kind: gating
      target: A
      condition_on: [B]
    - kind: gating
      target: B
      condition_on: [A]
{%- elif format_type == 'coord_list' %}
    representation_format:
    - name: A
      format: csr
      metadata_word_bits: 14
      metadata_storage_width: 28
      uop_payload_word_bits: 0
    - name: B
      format: csr
      metadata_word_bits: 14
      metadata_storage_width: 28
      uop_payload_word_bits: 0
    action_optimization:
    - kind: skipping
      target: A
      condition_on: [B]
    - kind: skipping
      target: B
      condition_on: [A]
{%- endif %}

  - !Memory
    name: Reg
    size: 1
    leak_power: 0
    area: 0
    total_latency: "max(max_tensor_read_actions, max_tensor_write_actions)"
    tensors: {keep: All}
    actions:
    - {name: read, energy: 0.49, bits_per_action: 8, latency: 0}
    - {name: write, energy: 0.49, bits_per_action: 8, latency: 0}
{%- if format_type == 'bitmask' %}
    action_optimization:
    - kind: gating
      target: Z
      condition_on: [A, B]
{%- elif format_type == 'coord_list' %}
    action_optimization:
    - kind: skipping
      target: Z
      condition_on: [A, B]
{%- endif %}

  - !Memory
    name: RegPassthrough
    size: 1
    leak_power: 0
    area: 0
    total_latency: "0"
    tensors: {keep: All}
    actions:
    - {name: read, energy: 0, bits_per_action: 8, latency: 0}
    - {name: write, energy: 0, bits_per_action: 8, latency: 0}

  - !Compute
    name: MAC
    leak_power: 0
    area: 0
    actions:
    - {name: compute, energy: 0.5608, latency: 1}
    - {name: gated_compute, energy: 0.03642, latency: 0}
{%- if format_type == 'bitmask' %}
    compute_optimization:
    - kind: gating
      target: Z
      condition_on: [A, B]
{%- elif format_type == 'coord_list' %}
    compute_optimization:
    - kind: skipping
      target: Z
      condition_on: [A, B]
{%- endif %}
