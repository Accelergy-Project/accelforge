# Fig 15 STC (Sparse Tensor Core) Architecture
# Same hierarchy as TC but with metadata/gated/skipped actions and different ERT values.
# DRAM write_bandwidth=32 (symmetric, vs TC's 16).
# ERT values from Sparseloop artifact: STC-RF2x-24-bandwidth/ERT_summary.yaml
# Sparse config (STC) inlined from sparse_stc.yaml.

arch:
  nodes:
  - !Memory
    name: DRAM
    size: 1e9
    leak_power: 0
    area: 0
    total_latency: "ceil(max(total_read_actions / 32, total_write_actions / 32))"
    tensors: {keep: ~Intermediates, may_keep: All}
    actions:
    - {name: read, energy: 512, bits_per_action: 64, latency: 0}
    - {name: write, energy: 512, bits_per_action: 64, latency: 0}
    - {name: metadata_read, energy: 0, bits_per_action: 64, latency: 0}
    - {name: metadata_write, energy: 0, bits_per_action: 64, latency: 0}
    representation_format:
    - name: A
      format: csr
      metadata_word_bits: 2

  - !Memory
    name: SMEM
    size: 2097152  # 256KB = 4096 depth × 512 width
    leak_power: 0
    area: 0
    total_latency: "ceil(max(total_read_actions / 42, total_write_actions / 42))"
    tensors: {keep: ~DRAM, may_keep: All}
    actions:
    - {name: read, energy: 285.71464, bits_per_action: 512, latency: 0}
    - {name: write, energy: 316.96744, bits_per_action: 512, latency: 0}
    - {name: metadata_read, energy: 25.8695, bits_per_action: 64, latency: 0}
    - {name: metadata_write, energy: 19.6486, bits_per_action: 64, latency: 0}
    representation_format:
    - name: A
      format: csr
      metadata_word_bits: 2

  - !Container
    name: Subpartitions
    spatial:
    - {name: Y, fanout: 4}

  - !Memory
    name: RF
    size: 16384  # 2048 depth × 8 width
    leak_power: 0
    area: 0
    total_latency: "0"
    tensors: {keep: All}
    actions:
    # Energy ÷ 16 (K_spatial): AF repeat_spatial inflates Z accesses by K_spatial=16
    # because Z doesn't depend on K. SL models K-spatial reduction; we compensate here.
    # Original: read=1.65889, write=1.67589, gated=0.00006
    - {name: read, energy: 0.103681, bits_per_action: 8, latency: 0}
    - {name: write, energy: 0.104743, bits_per_action: 8, latency: 0}
    - {name: gated_read, energy: 0.00000375, bits_per_action: 8, latency: 0}
    - {name: gated_write, energy: 0.00000375, bits_per_action: 8, latency: 0}
    - {name: skipped_read, energy: 0.0, bits_per_action: 8, latency: 0}
    - {name: skipped_write, energy: 0.0, bits_per_action: 8, latency: 0}
    action_optimization:
    - kind: skipping
      target: B
      condition_on: [A]
    - kind: skipping
      target: Z
      condition_on: [A]
    spatial:
    - {name: X, fanout: 16}
    - {name: Z, fanout: 16}

  - !Memory
    name: LRF
    size: 8  # 1 depth × 8 width
    leak_power: 0
    area: 0
    total_latency: "0"
    tensors: {keep: All}
    actions:
    - {name: read, energy: 0.072, bits_per_action: 8, latency: 0}
    - {name: write, energy: 0.072, bits_per_action: 8, latency: 0}
    - {name: gated_read, energy: 0.00296, bits_per_action: 8, latency: 0}
    - {name: gated_write, energy: 0.00296, bits_per_action: 8, latency: 0}
    - {name: metadata_read, energy: 0.072, bits_per_action: 8, latency: 0}
    - {name: metadata_write, energy: 0.072, bits_per_action: 8, latency: 0}
    representation_format:
    - name: A
      format: csr
      metadata_word_bits: 2

  - !Compute
    name: MAC
    leak_power: 0
    area: 0
    actions:
    - {name: compute, energy: 0.5608, latency: 1}
    - {name: gated_compute, energy: 0.01798, latency: 0}
    - {name: skipped_compute, energy: 0.01798, latency: 0}
    compute_optimization:
    - kind: skipping
      target: GEMM
      condition_on: [A]
